<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Appointments - Dokter</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .appointments-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .appointment-card {
        background: white;
        border: 2px solid #e0e0e0;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .appointment-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .patient-name {
        font-size: 1.4em;
        font-weight: bold;
        color: #333;
      }

      .appointment-status {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
      }

      .status-menunggu {
        background: #fff3e0;
        color: #e65100;
      }

      .status-dikonfirmasi {
        background: #e3f2fd;
        color: #1565c0;
      }

      .status-selesai {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .status-dibatalkan {
        background: #ffebee;
        color: #c62828;
      }

      .appointment-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .detail-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .detail-label {
        font-size: 0.85em;
        color: #666;
        font-weight: 500;
      }

      .detail-value {
        font-size: 1em;
        color: #333;
      }

      .complaint-section {
        margin-top: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
      }

      .complaint-label {
        font-size: 0.9em;
        color: #666;
        font-weight: 500;
        margin-bottom: 8px;
      }

      .complaint-text {
        color: #333;
        line-height: 1.6;
      }

      .filter-section {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      .filter-btn {
        padding: 10px 20px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
      }

      .filter-btn.active {
        background: #5e936c;
        color: white;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
        font-size: 1.2em;
      }

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #5e936c;
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .btn-action-small {
        padding: 10px 18px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.9em;
        transition: all 0.2s;
      }

      .btn-confirm {
        background: #4caf50;
        color: white;
      }

      .btn-confirm:hover {
        background: #45a049;
      }

      .btn-complete {
        background: #2196f3;
        color: white;
      }

      .btn-complete:hover {
        background: #0b7dda;
      }

      .btn-cancel-doc {
        background: #f44336;
        color: white;
      }

      .btn-cancel-doc:hover {
        background: #d32f2f;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <nav class="navbar">
        <div class="navbar-brand">
          <h2>Clinic Appointment System - Dokter</h2>
        </div>
        <div class="navbar-menu">
          <span id="userName"></span>
          <a
            href="dashboard.html"
            style="color: white; text-decoration: none; margin-right: 15px"
            >Dashboard</a
          >
          <a
            href="dokter-schedules.html"
            style="color: white; text-decoration: none; margin-right: 15px"
            >My Schedules</a
          >
          <button onclick="logout()" class="btn-logout">Logout</button>
        </div>
      </nav>

      <div class="dashboard-content">
        <h1>My Appointments</h1>

        <div class="stats-container" id="statsContainer"></div>

        <div class="filter-section">
          <button class="filter-btn active" onclick="filterAppointments('all')">
            All
          </button>
          <button class="filter-btn" onclick="filterAppointments('Menunggu')">
            Menunggu
          </button>
          <button
            class="filter-btn"
            onclick="filterAppointments('Dikonfirmasi')"
          >
            Dikonfirmasi
          </button>
          <button class="filter-btn" onclick="filterAppointments('Selesai')">
            Selesai
          </button>
          <button class="filter-btn" onclick="filterAppointments('Dibatalkan')">
            Dibatalkan
          </button>
        </div>

        <div class="appointments-container" id="appointmentsContainer"></div>
      </div>
    </div>

    <script src="auth.js"></script>
    <script>
      const token = localStorage.getItem("authToken");
      const user = JSON.parse(localStorage.getItem("user") || "{}");

      if (!token || user.role !== "dokter") {
        window.location.href = "index.html";
      }

      document.getElementById("userName").textContent = user.name;

      let allAppointments = [];
      let currentFilter = "all";

      async function loadAppointments() {
        try {
          const response = await authenticatedFetch(
            "/dokter-schedule/my-appointments"
          );
          allAppointments = await response.json();

          displayStats();
          displayAppointments(allAppointments);
        } catch (error) {
          console.error("Error loading appointments:", error);
          alert("Failed to load appointments");
        }
      }

      function displayStats() {
        const stats = {
          total: allAppointments.length,
          menunggu: allAppointments.filter((a) => a.status === "Menunggu")
            .length,
          dikonfirmasi: allAppointments.filter(
            (a) => a.status === "Dikonfirmasi"
          ).length,
          selesai: allAppointments.filter((a) => a.status === "Selesai").length,
        };

        document.getElementById("statsContainer").innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Appointments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.menunggu}</div>
                    <div class="stat-label">Menunggu</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.dikonfirmasi}</div>
                    <div class="stat-label">Dikonfirmasi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.selesai}</div>
                    <div class="stat-label">Selesai</div>
                </div>
            `;
      }

      function displayAppointments(appointments) {
        const container = document.getElementById("appointmentsContainer");

        if (appointments.length === 0) {
          container.innerHTML =
            '<div class="empty-state">No appointments found</div>';
          return;
        }

        container.innerHTML = appointments
          .map((appointment) => {
            const date = new Date(appointment.tanggal_janji);
            const formattedDate = date.toLocaleDateString("id-ID", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });

            return `
                    <div class="appointment-card">
                        <div class="appointment-header">
                            <div class="patient-name">${
                              appointment.nama_pasien
                            }</div>
                            <span class="appointment-status status-${appointment.status.toLowerCase()}">${
              appointment.status
            }</span>
                        </div>

                        <div class="appointment-details">
                            <div class="detail-item">
                                <span class="detail-label">Appointment Date</span>
                                <span class="detail-value">${formattedDate}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Schedule</span>
                                <span class="detail-value">${
                                  appointment.hari
                                }, ${appointment.waktu_mulai} - ${
              appointment.waktu_selesai
            }</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Gender</span>
                                <span class="detail-value">${
                                  appointment.jenis_kelamin
                                }</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Phone</span>
                                <span class="detail-value">${
                                  appointment.pasien_telepon
                                }</span>
                            </div>
                        </div>

                        <div class="complaint-section">
                            <div class="complaint-label">Patient Complaint:</div>
                            <div class="complaint-text">${
                              appointment.keluhan
                            }</div>
                        </div>

                        ${getActionButtons(appointment)}
                    </div>
                `;
          })
          .join("");
      }

      function getActionButtons(appointment) {
        const status = appointment.status;
        const id = appointment.janjitemu_id;

        if (status === "Selesai" || status === "Dibatalkan") {
          return ""; // No actions for completed or cancelled appointments
        }

        let buttons = '<div class="action-buttons">';

        if (status === "Menunggu") {
          buttons += `
                    <button class="btn-action-small btn-confirm" onclick="confirmAppointment(${id})">
                        Confirm
                    </button>
                    <button class="btn-action-small btn-cancel-doc" onclick="cancelAppointment(${id})">
                        Cancel
                    </button>
                `;
        } else if (status === "Dikonfirmasi") {
          buttons += `
                    <button class="btn-action-small btn-complete" onclick="completeAppointment(${id})">
                        Mark as Completed
                    </button>
                    <button class="btn-action-small btn-cancel-doc" onclick="cancelAppointment(${id})">
                        Cancel
                    </button>
                `;
        }

        buttons += "</div>";
        return buttons;
      }

      async function confirmAppointment(id) {
        if (!confirm("Confirm this appointment?")) {
          return;
        }

        try {
          const response = await authenticatedFetch(
            `/dokter-schedule/confirm-appointment/${id}`,
            {
              method: "PUT",
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert("Appointment confirmed successfully!");
            loadAppointments();
          } else {
            alert(data.message || "Failed to confirm appointment");
          }
        } catch (error) {
          console.error("Error confirming appointment:", error);
          alert("Failed to confirm appointment");
        }
      }

      async function cancelAppointment(id) {
        if (!confirm("Are you sure you want to cancel this appointment?")) {
          return;
        }

        try {
          const response = await authenticatedFetch(
            `/dokter-schedule/cancel-appointment/${id}`,
            {
              method: "PUT",
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert("Appointment cancelled successfully");
            loadAppointments();
          } else {
            alert(data.message || "Failed to cancel appointment");
          }
        } catch (error) {
          console.error("Error cancelling appointment:", error);
          alert("Failed to cancel appointment");
        }
      }

      async function completeAppointment(id) {
        if (!confirm("Mark this appointment as completed?")) {
          return;
        }

        try {
          const response = await authenticatedFetch(
            `/dokter-schedule/complete-appointment/${id}`,
            {
              method: "PUT",
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert("Appointment marked as completed!");
            loadAppointments();
          } else {
            alert(data.message || "Failed to complete appointment");
          }
        } catch (error) {
          console.error("Error completing appointment:", error);
          alert("Failed to complete appointment");
        }
      }

      function filterAppointments(status) {
        currentFilter = status;

        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        let filtered = allAppointments;
        if (status !== "all") {
          filtered = allAppointments.filter((a) => a.status === status);
        }

        displayAppointments(filtered);
      }

      loadAppointments();
    </script>
  </body>
</html>
