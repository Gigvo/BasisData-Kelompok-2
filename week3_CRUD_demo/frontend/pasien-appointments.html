<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Appointment - Pasien</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
      }

      .tab {
        padding: 12px 24px;
        background: #f5f5f5;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
      }

      .tab.active {
        background: #5e936c;
        color: white;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .schedule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .schedule-card {
        background: white;
        border: 2px solid #e0e0e0;
        padding: 25px;
        border-radius: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .schedule-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .schedule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .schedule-day {
        font-size: 1.4em;
        font-weight: bold;
        color: #333;
      }

      .doctor-info {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .doctor-name {
        font-size: 1.1em;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .doctor-specialty {
        color: #666;
        font-size: 0.95em;
      }

      .schedule-time {
        color: #666;
        margin: 10px 0;
        font-size: 1em;
      }

      .btn-book {
        width: 100%;
        padding: 12px;
        background: #5e936c;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 1em;
        transition: all 0.2s;
        margin-top: 10px;
      }

      .btn-book:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
        font-size: 1.2em;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        font-size: 1.8em;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
      }

      .close-modal {
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #999;
      }

      .close-modal:hover {
        color: #333;
      }

      .appointment-card {
        background: white;
        border: 2px solid #e0e0e0;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .doctor-name-large {
        font-size: 1.4em;
        font-weight: bold;
        color: #333;
      }

      .appointment-status {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
      }

      .status-menunggu {
        background: #fff3e0;
        color: #e65100;
      }

      .status-dikonfirmasi {
        background: #e3f2fd;
        color: #1565c0;
      }

      .status-selesai {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .status-dibatalkan {
        background: #ffebee;
        color: #c62828;
      }

      .appointment-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }

      .detail-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .detail-label {
        font-size: 0.85em;
        color: #666;
        font-weight: 500;
      }

      .detail-value {
        font-size: 1em;
        color: #333;
      }

      .complaint-section {
        margin-top: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
      }

      .btn-cancel {
        background: #f44336;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        margin-top: 15px;
        transition: all 0.2s;
      }

      .btn-cancel:hover {
        background: #d32f2f;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <nav class="navbar">
        <div class="navbar-brand">
          <h2>Clinic Appointment System - Pasien</h2>
        </div>
        <div class="navbar-menu">
          <span id="userName"></span>
          <a
            href="dashboard.html"
            style="color: white; text-decoration: none; margin-right: 15px"
            >Dashboard</a
          >
          <button onclick="logout()" class="btn-logout">Logout</button>
        </div>
      </nav>

      <div class="dashboard-content">
        <h1>Appointments</h1>

        <div class="tabs">
          <button class="tab active" onclick="switchTab('book')">
            Book Appointment
          </button>
          <button class="tab" onclick="switchTab('my-appointments')">
            My Appointments
          </button>
        </div>

        <div id="book" class="tab-content active">
          <h2 style="margin-bottom: 20px">Available Schedules</h2>
          <div id="schedulesGrid" class="schedule-grid"></div>
        </div>

        <div id="my-appointments" class="tab-content">
          <h2 style="margin-bottom: 20px">My Appointments</h2>
          <div id="appointmentsContainer"></div>
        </div>
      </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div class="modal-header">Book Appointment</div>

        <form id="bookingForm">
          <input type="hidden" id="selectedJadwalId" />

          <div class="form-group">
            <label>Doctor</label>
            <input
              type="text"
              id="modalDoctorName"
              readonly
              style="background: #f5f5f5"
            />
          </div>

          <div class="form-group">
            <label>Schedule</label>
            <input
              type="text"
              id="modalSchedule"
              readonly
              style="background: #f5f5f5"
            />
          </div>

          <div class="form-group">
            <label for="appointmentDate">Appointment Date</label>
            <input type="date" id="appointmentDate" required />
          </div>

          <div class="form-group">
            <label for="complaint">Complaint / Reason</label>
            <textarea
              id="complaint"
              rows="4"
              required
              placeholder="Describe your symptoms or reason for visit"
            ></textarea>
          </div>

          <div class="error-message" id="bookingError"></div>

          <button type="submit" class="btn-primary">Confirm Booking</button>
        </form>
      </div>
    </div>

    <script src="auth.js"></script>
    <script>
      const token = localStorage.getItem("authToken");
      const user = JSON.parse(localStorage.getItem("user") || "{}");

      if (!token || user.role !== "pasien") {
        window.location.href = "index.html";
      }

      document.getElementById("userName").textContent = user.name;

      function switchTab(tabName) {
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        event.target.classList.add("active");
        document.getElementById(tabName).classList.add("active");

        if (tabName === "my-appointments") {
          loadMyAppointments();
        }
      }

      async function loadAvailableSchedules() {
        try {
          const response = await authenticatedFetch(
            "/pasien-appointment/available-schedules"
          );
          const schedules = await response.json();

          const grid = document.getElementById("schedulesGrid");

          if (schedules.length === 0) {
            grid.innerHTML =
              '<div class="empty-state">No available schedules at the moment</div>';
            return;
          }

          grid.innerHTML = schedules
            .map(
              (schedule) => `
                    <div class="schedule-card">
                        <div class="schedule-header">
                            <div class="schedule-day">${schedule.hari}</div>
                        </div>
                        <div class="schedule-time">
                            ${schedule.waktu_mulai} - ${schedule.waktu_selesai}
                        </div>
                        ${
                          schedule.dokter_id
                            ? `
                            <div class="doctor-info">
                                <div class="doctor-name">${schedule.nama_dokter}</div>
                                <div class="doctor-specialty">${schedule.spesialisasi}</div>
                            </div>
                        `
                            : `
                            <div class="doctor-info">
                                <div style="color: #999;">No doctor assigned yet</div>
                            </div>
                        `
                        }
                        ${
                          schedule.dokter_id
                            ? `
                            <button class="btn-book" onclick='openBookingModal(${JSON.stringify(
                              schedule
                            )})'>
                                Book This Slot
                            </button>
                        `
                            : `
                            <button class="btn-book" disabled style="opacity: 0.5; cursor: not-allowed;">
                                Not Available
                            </button>
                        `
                        }
                    </div>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading schedules:", error);
          alert("Failed to load schedules");
        }
      }

      function openBookingModal(schedule) {
        document.getElementById("selectedJadwalId").value = schedule.jadwal_id;
        document.getElementById("modalDoctorName").value = schedule.nama_dokter;
        document.getElementById(
          "modalSchedule"
        ).value = `${schedule.hari}, ${schedule.waktu_mulai} - ${schedule.waktu_selesai}`;

        const today = new Date().toISOString().split("T")[0];
        document.getElementById("appointmentDate").min = today;

        document.getElementById("bookingModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("bookingModal").style.display = "none";
        document.getElementById("bookingForm").reset();
        document.getElementById("bookingError").style.display = "none";
      }

      document
        .getElementById("bookingForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const jadwal_id = document.getElementById("selectedJadwalId").value;
          const tanggal_janji =
            document.getElementById("appointmentDate").value;
          const keluhan = document.getElementById("complaint").value;

          try {
            const response = await authenticatedFetch(
              "/pasien-appointment/create",
              {
                method: "POST",
                body: JSON.stringify({ jadwal_id, tanggal_janji, keluhan }),
              }
            );

            const data = await response.json();

            if (response.ok) {
              alert("Appointment booked successfully!");
              closeModal();
              loadAvailableSchedules();
            } else {
              const errorEl = document.getElementById("bookingError");
              errorEl.textContent =
                data.message || "Failed to book appointment";
              errorEl.style.display = "block";
            }
          } catch (error) {
            console.error("Error booking appointment:", error);
            const errorEl = document.getElementById("bookingError");
            errorEl.textContent = "Network error. Please try again.";
            errorEl.style.display = "block";
          }
        });

      async function loadMyAppointments() {
        try {
          const response = await authenticatedFetch(
            "/pasien-appointment/my-appointments"
          );
          const appointments = await response.json();

          const container = document.getElementById("appointmentsContainer");

          if (appointments.length === 0) {
            container.innerHTML =
              '<div class="empty-state">You have no appointments yet</div>';
            return;
          }

          container.innerHTML = appointments
            .map((appointment) => {
              const date = new Date(appointment.tanggal_janji);
              const formattedDate = date.toLocaleDateString("id-ID", {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
              });

              return `
                        <div class="appointment-card">
                            <div class="appointment-header">
                                <div class="doctor-name-large">${
                                  appointment.nama_dokter
                                }</div>
                                <span class="appointment-status status-${appointment.status.toLowerCase()}">${
                appointment.status
              }</span>
                            </div>

                            <div class="appointment-details">
                                <div class="detail-item">
                                    <span class="detail-label">Specialty</span>
                                    <span class="detail-value">${
                                      appointment.spesialisasi
                                    }</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Appointment Date</span>
                                    <span class="detail-value">${formattedDate}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Schedule</span>
                                    <span class="detail-value">${
                                      appointment.hari
                                    }, ${appointment.waktu_mulai} - ${
                appointment.waktu_selesai
              }</span>
                                </div>
                            </div>

                            <div class="complaint-section">
                                <div class="detail-label">Your Complaint:</div>
                                <div style="margin-top: 8px; color: #333;">${
                                  appointment.keluhan
                                }</div>
                            </div>

                            ${
                              appointment.status === "Menunggu" ||
                              appointment.status === "Dikonfirmasi"
                                ? `
                                <button class="btn-cancel" onclick="cancelAppointment(${appointment.janjitemu_id})">
                                    Cancel Appointment
                                </button>
                            `
                                : ""
                            }
                        </div>
                    `;
            })
            .join("");
        } catch (error) {
          console.error("Error loading appointments:", error);
          alert("Failed to load appointments");
        }
      }

      async function cancelAppointment(appointmentId) {
        if (!confirm("Are you sure you want to cancel this appointment?")) {
          return;
        }

        try {
          const response = await authenticatedFetch(
            `/pasien-appointment/cancel/${appointmentId}`,
            {
              method: "PUT",
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert("Appointment cancelled successfully");
            loadMyAppointments();
            loadAvailableSchedules();
          } else {
            alert(data.message || "Failed to cancel appointment");
          }
        } catch (error) {
          console.error("Error cancelling appointment:", error);
          alert("Failed to cancel appointment");
        }
      }

      window.onclick = function (event) {
        const modal = document.getElementById("bookingModal");
        if (event.target === modal) {
          closeModal();
        }
      };

      loadAvailableSchedules();
    </script>
  </body>
</html>
